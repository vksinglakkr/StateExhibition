<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>State Exhibition ‚Äì New Prosecution Laws 2024</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body {
      background: linear-gradient(135deg, #e0f2fe 0%, #fef3c7 100%);
      font-family: 'Inter', sans-serif;
    }
    .fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section-badge {
      cursor: pointer;
      transition: all 0.2s;
    }
    .section-badge:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

  <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-800 to-indigo-600 text-white rounded-t-2xl p-6 text-center">
      <h1 class="text-2xl font-bold mb-2">State Exhibition on New Prosecution Laws ‚Äì 2024</h1>
      <p class="text-blue-100">AI Chatbot powered by Groq + Llama 3.3</p>
    </div>

    <!-- Form -->
    <div class="p-6 space-y-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
        <input id="name" class="w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 p-2" placeholder="e.g. Vinod Singla" />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Select a ready question</label>
        <div id="sampleQuestions" class="max-h-56 overflow-auto border border-gray-300 rounded-lg p-3 space-y-2 bg-gray-50"></div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Or type your own question</label>
        <textarea id="question" rows="4" class="w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-600 focus:border-blue-600 p-2" placeholder="Type your custom question..."></textarea>
      </div>

      <!-- Language Selector -->
      <div class="flex items-center space-x-2">
        <span class="text-gray-700 font-medium">Answer Language:</span>
        <button class="langBtn px-3 py-1 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition" data-lang="English">English</button>
        <button class="langBtn px-3 py-1 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition" data-lang="Hindi">Hindi</button>
        <button class="langBtn px-3 py-1 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition" data-lang="Punjabi">Punjabi</button>
      </div>

      <div class="flex items-center space-x-4 flex-wrap gap-2">
        <button id="submitBtn" class="flex items-center justify-center gap-2 bg-blue-700 text-white px-5 py-2 rounded-xl shadow hover:bg-blue-800 transition">
          <i data-lucide="send"></i> <span>Ask AI</span>
        </button>

        <!-- Voice Input Button -->
        <button id="voiceBtn" class="flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-2 rounded-xl shadow hover:bg-green-700 transition">
          <i data-lucide="mic"></i> <span>Speak</span>
        </button>

        <!-- NEW: Search Sections Button -->
        <button id="searchSectionsBtn" class="flex items-center justify-center gap-2 bg-purple-600 text-white px-5 py-2 rounded-xl shadow hover:bg-purple-700 transition">
          <i data-lucide="database"></i> <span>Search Sections</span>
        </button>

        <button id="mainPageBtn" class="flex items-center justify-center gap-2 bg-gray-500 text-white px-5 py-2 rounded-xl shadow hover:bg-gray-600 transition">
          <i data-lucide="home"></i> <span>Main Page</span>
        </button>
        <span id="status" class="text-gray-500"></span>
      </div>
    </div>

    <!-- Footer -->
    <footer style="text-align:center; font-size:13px; color:#666; margin-top:30px; padding:12px; border-top:1px solid #ccc;">
      <p><strong>Disclaimer:</strong> This is an AI-generated response. Accuracy is not guaranteed and the content may be based on outdated information. Please verify through official sources.</p>
      <p>Designed by <strong>NIC, Kurukshetra</strong> for <strong>District Administration, Kurukshetra</strong></p>
      <p>Last Modified: <span id="lastModified"></span></p>
      
      <script>
        document.getElementById("lastModified").textContent = new Date(document.lastModified).toLocaleString();
      </script>
    </footer>

  </div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 fade-in">
      <div class="flex justify-between items-center border-b px-5 py-3 bg-blue-700 text-white rounded-t-2xl">
        <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="message-circle"></i> AI Response</h2>
        <button id="closeModal" class="hover:text-gray-200"><i data-lucide="x"></i></button>
      </div>
      <div class="p-5 max-h-[70vh] overflow-y-auto">
        <p class="font-semibold text-gray-700 mb-2">Question:</p>
        <pre id="userQuestion" class="whitespace-pre-wrap text-gray-800 mb-4"></pre>
        <p class="font-semibold text-gray-700 mb-2">Answer:</p>
        <div id="aiAnswer" class="whitespace-pre-wrap text-gray-800"></div>
      </div>
      <div class="border-t p-4 flex justify-end gap-3">
        <button id="copyBtn" class="flex items-center gap-1 px-4 py-2 border rounded-lg hover:bg-gray-100 transition"><i data-lucide="copy"></i> Copy</button>
        <button id="mainPageModalBtn" class="flex items-center gap-1 px-4 py-2 border rounded-lg hover:bg-gray-100 transition"><i data-lucide="home"></i> Main Page</button>
        <button id="closeBtn" class="bg-blue-700 text-white px-5 py-2 rounded-lg hover:bg-blue-800 transition">Close</button>
      </div>
    </div>
  </div>

  <!-- Help Modal for Section Navigation -->
  <div id="helpModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 fade-in">
      <div class="flex justify-between items-center border-b px-5 py-3 bg-green-600 text-white rounded-t-2xl">
        <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="info"></i> How to Find Section</h2>
        <button id="closeHelpModal" class="hover:text-gray-200"><i data-lucide="x"></i></button>
      </div>
      <div class="p-5">
        <div class="mb-4">
          <p class="text-gray-700 mb-3">The India Code page will open in a new tab. Follow these steps:</p>
          <ol class="list-decimal list-inside space-y-2 text-gray-700">
            <li>Look for the <strong>"Sections"</strong> tab (usually already selected)</li>
            <li>Find <strong id="helpSectionText" class="text-blue-600">Section X</strong> in the list on the left side</li>
            <li>Click on it to view the complete section text</li>
          </ol>
        </div>
        <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
          <p class="text-sm text-blue-800">
            <i data-lucide="lightbulb" class="inline w-4 h-4"></i>
            <strong>Tip:</strong> You can use Ctrl+F (or Cmd+F on Mac) to search for "Section <span id="helpSectionNum"></span>" on the page.
          </p>
        </div>
      </div>
      <div class="border-t p-4 flex justify-end gap-3">
        <button id="dontShowAgain" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition text-sm">Don't show again</button>
        <button id="proceedToSection" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition">Got it, Open Page</button>
      </div>
    </div>
  </div>

  <script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      lucide.createIcons();
    });

    const WEBHOOK_URL = 'https://n8n-workflow-test.duckdns.org/webhook/chatbot';

    // Section URL mapping for Indian Criminal Laws
    const SECTION_URLS = {
      'BNS': 'https://www.indiacode.nic.in/handle/123456789/20062',
      'BNSS': 'https://www.indiacode.nic.in/handle/123456789/20099',
      'BSA': 'https://www.indiacode.nic.in/handle/123456789/20063',
      'IPC': 'https://www.indiacode.nic.in/handle/123456789/2263',
      'CrPC': 'https://www.indiacode.nic.in/handle/123456789/1362',
      'Evidence': 'https://www.indiacode.nic.in/handle/123456789/2188'
    };

    function getSectionUrl(lawType, sectionNum) {
      return SECTION_URLS[lawType] || 'https://www.indiacode.nic.in';
    }

    const samples = [
      "What are the three new prosecution laws implemented since 2024?",
      "How have the new laws changed the FIR process?",
      "Are bail provisions modified under the new system?",
      "How are cybercrimes treated under the new prosecution laws?",
      "What changes exist in the evidence collection process?",
      "Do victims get more rights or faster justice now?",
      "Are new offences introduced or penalties enhanced?",
      "How do the new laws ensure speedy trials?",
      "Do these laws affect existing criminal cases?",
      "Any changes to police powers or arrest procedures?",
      "What about reforms in case hearings and appeals?",
      "How are economic crimes handled differently?",
      "Do these laws simplify court processes?",
      "Is digital submission of evidence allowed now?",
      "What are the main benefits for citizens?",
      "How do these laws support fair prosecution?",
      "Are there any guidelines for prosecutors?",
      "What are the penalties for delaying investigation?",
      "How can I access the official text of the laws?",
      "Do these laws align with constitutional rights?"
    ];

    const container = document.getElementById('sampleQuestions');
    samples.forEach((q,i)=>{
      const id = 'q'+i;
      const div = document.createElement('div');
      div.className = 'flex items-start';
      div.innerHTML = `
        <input type="radio" id="${id}" name="sampleQ" value="${q}" class="mt-1 text-blue-600 focus:ring-blue-600">
        <label for="${id}" class="ml-2 text-sm text-gray-700 cursor-pointer hover:text-blue-700">${q}</label>
      `;
      container.appendChild(div);
    });
    container.addEventListener('change', e=>{
      if(e.target.name==='sampleQ')
        document.getElementById('question').value=e.target.value;
    });

    const modal=document.getElementById('modal');
    const openModal=()=>modal.classList.remove('hidden');
    const closeModal=()=>modal.classList.add('hidden');
    document.getElementById('closeBtn').onclick=closeModal;
    document.getElementById('closeModal').onclick=closeModal;

    // Main page buttons
    document.getElementById('mainPageBtn').onclick = () => { window.location.href = 'index.html'; }
    document.getElementById('mainPageModalBtn').onclick = () => { window.location.href = 'index.html'; }

    // NEW: Search Sections Button
    document.getElementById('searchSectionsBtn').onclick = () => { 
      window.location.href = 'section-search.html'; 
    }

    // Language selection
    let selectedLanguage = 'English';
    document.querySelectorAll('.langBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        selectedLanguage = this.dataset.lang;
        document.querySelectorAll('.langBtn').forEach(b => b.classList.replace('bg-blue-700', 'bg-gray-500'));
        this.classList.replace('bg-gray-500', 'bg-blue-700');
      });
    });

    function processAnswerWithLinks(text) {
      // Convert markdown tables to HTML tables
      text = convertMarkdownTables(text);

      // Convert section references to highlighted badges with direct links
      text = text.replace(/\[?BNS[S]?\s*(?:Section\s*)?[¬ß]?\s*(\d+)\]?/gi, (match, sectionNum) => {
        const url = getSectionUrl('BNSS', sectionNum);
        return `<a href="${url}" target="_blank" class="section-badge inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-semibold mx-1 hover:bg-purple-200" title="Click to view BNSS Section ${sectionNum}">BNSS ¬ß${sectionNum}</a>`;
      });
      
      text = text.replace(/\[?BN[S]?\s*(?:Section\s*)?[¬ß]?\s*(\d+)\]?/gi, (match, sectionNum) => {
        const url = getSectionUrl('BNS', sectionNum);
        return `<a href="${url}" target="_blank" class="section-badge inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-semibold mx-1 hover:bg-green-200" title="Click to view BNS Section ${sectionNum}">BNS ¬ß${sectionNum}</a>`;
      });
      
      text = text.replace(/\[?IPC\s*(?:Section\s*)?[¬ß]?\s*(\d+)\]?/gi, (match, sectionNum) => {
        const url = getSectionUrl('IPC', sectionNum);
        return `<a href="${url}" target="_blank" class="section-badge inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-semibold mx-1 hover:bg-blue-200" title="Click to view IPC Section ${sectionNum}">IPC ¬ß${sectionNum}</a>`;
      });
      
      text = text.replace(/\[?CrPC\s*(?:Section\s*)?[¬ß]?\s*(\d+)\]?/gi, (match, sectionNum) => {
        const url = getSectionUrl('CrPC', sectionNum);
        return `<a href="${url}" target="_blank" class="section-badge inline-block bg-orange-100 text-orange-800 px-2 py-1 rounded text-sm font-semibold mx-1 hover:bg-orange-200" title="Click to view CrPC Section ${sectionNum}">CrPC ¬ß${sectionNum}</a>`;
      });
      
      text = text.replace(/\[?BSA\s*(?:Section\s*)?[¬ß]?\s*(\d+)\]?/gi, (match, sectionNum) => {
        const url = getSectionUrl('BSA', sectionNum);
        return `<a href="${url}" target="_blank" class="section-badge inline-block bg-teal-100 text-teal-800 px-2 py-1 rounded text-sm font-semibold mx-1 hover:bg-teal-200" title="Click to view BSA Section ${sectionNum}">BSA ¬ß${sectionNum}</a>`;
      });
      
      text = text.replace(/\[?(?:Evidence Act|Indian Evidence Act)\s*(?:Section\s*)?[¬ß]?\s*(\d+)\]?/gi, (match, sectionNum) => {
        const url = getSectionUrl('Evidence', sectionNum);
        return `<a href="${url}" target="_blank" class="section-badge inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm font-semibold mx-1 hover:bg-yellow-200" title="Click to view Evidence Act Section ${sectionNum}">Evidence Act ¬ß${sectionNum}</a>`;
      });

      // Convert standalone URLs to clickable links
      text = text.replace(/(^|[^"'>])(https?:\/\/[^\s<]+)/g, '$1<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline font-medium">$2</a>');

      // Format headers
      text = text.replace(/üìö READ THE FULL LAWS:/g, '<strong class="block mt-3 mb-1 text-lg">üìö READ THE FULL LAWS:</strong>');
      text = text.replace(/‚úÖ NEW LAWS \(2024\):/g, '<strong class="block mt-2 text-green-700">‚úÖ NEW LAWS (2024):</strong>');
      text = text.replace(/üìú OLD LAWS \(For Reference\):/g, '<strong class="block mt-2 text-blue-700">üìú OLD LAWS (For Reference):</strong>');
      text = text.replace(/üîó Official Resources:/g, '<strong class="block mt-2 text-purple-700">üîó Official Resources:</strong>');
      
      // Format section headers with emojis
      text = text.replace(/üìã GIST\/SUMMARY:/gi, '<strong class="block mt-3 mb-1 text-base">üìã GIST/SUMMARY:</strong>');
      text = text.replace(/üìñ SECTION TEXT:/gi, '<strong class="block mt-3 mb-1 text-base">üìñ SECTION TEXT:</strong>');
      text = text.replace(/‚öñÔ∏è PUNISHMENT\/PENALTY:/gi, '<strong class="block mt-3 mb-1 text-base">‚öñÔ∏è PUNISHMENT/PENALTY:</strong>');
      text = text.replace(/üîÑ COMPARISON TABLE:/gi, '<strong class="block mt-3 mb-1 text-base">üîÑ COMPARISON TABLE:</strong>');
      text = text.replace(/üéØ KEY ELEMENTS:/gi, '<strong class="block mt-3 mb-1 text-base">üéØ KEY ELEMENTS:</strong>');
      text = text.replace(/üìù PRACTICAL EXAMPLES:/gi, '<strong class="block mt-3 mb-1 text-base">üìù PRACTICAL EXAMPLES:</strong>');
      text = text.replace(/üîó RELATED SECTIONS:/gi, '<strong class="block mt-3 mb-1 text-base">üîó RELATED SECTIONS:</strong>');
      text = text.replace(/üí° IMPORTANT NOTES:/gi, '<strong class="block mt-3 mb-1 text-base">üí° IMPORTANT NOTES:</strong>');

      // Preserve line breaks
      text = text.replace(/\n/g, '<br>');

      return text;
    }

    function convertMarkdownTables(text) {
      const tableRegex = /\|(.+)\|[\r\n]+\|[\s\-:|]+\|[\r\n]+((?:\|.+\|[\r\n]*)+)/g;
      
      return text.replace(tableRegex, function(match, headerRow, bodyRows) {
        const headers = headerRow.split('|').map(h => h.trim()).filter(h => h);
        const rows = bodyRows.trim().split('\n').map(row => {
          return row.split('|').map(cell => cell.trim()).filter(cell => cell);
        });
        
        let html = '<table class="w-full border-collapse border border-gray-300 my-4">';
        html += '<thead class="bg-blue-100"><tr>';
        headers.forEach(header => {
          html += `<th class="border border-gray-300 px-4 py-2 text-left font-semibold">${header}</th>`;
        });
        html += '</tr></thead>';
        
        html += '<tbody>';
        rows.forEach(row => {
          if (row.length > 0) {
            html += '<tr class="hover:bg-gray-50">';
            row.forEach(cell => {
              html += `<td class="border border-gray-300 px-4 py-2">${cell}</td>`;
            });
            html += '</tr>';
          }
        });
        html += '</tbody></table>';
        
        return html;
      });
    }

    document.getElementById('submitBtn').addEventListener('click', async()=>{
      const name = document.getElementById('name').value.trim() || 'Visitor';
      const question = document.getElementById('question').value.trim();
      if(!question){ alert('Please enter a question'); return; }

      document.getElementById('submitBtn').disabled=true;
      document.getElementById('status').textContent='Getting response...';

      try{
        const res = await fetch(WEBHOOK_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name, question, language: selectedLanguage })
        });

        let answerText = '';
        if (res.ok) {
          const data = await res.json();
          answerText = data.answer || data.error || "No answer received.";
        } else {
          answerText = `Error: ${res.status} ${res.statusText}`;
        }

        answerText = processAnswerWithLinks(answerText);

        document.getElementById('userQuestion').textContent = question;
        document.getElementById('aiAnswer').innerHTML = answerText;
        
        openModal();
      } catch(err){
        alert('Connection failed: ' + err.message);
      } finally {
        document.getElementById('submitBtn').disabled=false;
        document.getElementById('status').textContent='';
      }
    });

    // Voice Input Setup
    let recognition;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('question').value = transcript;
        document.getElementById('status').textContent = '';
        updateVoiceButton('mic', 'Speak');
      };

      recognition.onerror = (event) => {
        console.error('Voice error:', event.error);
        document.getElementById('status').textContent = 'Voice error: ' + event.error;
        updateVoiceButton('mic', 'Speak');
      };

      recognition.onend = () => {
        updateVoiceButton('mic', 'Speak');
      };
    }

    function updateVoiceButton(icon, text) {
      document.getElementById('voiceBtn').innerHTML = `<i data-lucide="${icon}"></i> <span>${text}</span>`;
      lucide.createIcons();
    }

    document.getElementById('voiceBtn').addEventListener('click', () => {
      if (!recognition) {
        alert('Voice input not supported. Try Chrome or Edge.');
        return;
      }

      const langMap = {
        'English': 'en-IN',
        'Hindi': 'hi-IN',
        'Punjabi': 'pa-IN'
      };
      recognition.lang = langMap[selectedLanguage] || 'en-IN';

      updateVoiceButton('mic-off', 'Listening...');
      document.getElementById('status').textContent = 'Listening... Speak now.';

      try {
        recognition.start();
      } catch (err) {
        console.error('Voice start error:', err);
        document.getElementById('status').textContent = 'Voice error: ' + err.message;
        updateVoiceButton('mic', 'Speak');
      }
    });

    document.getElementById('copyBtn').onclick = ()=>{
      const answerDiv = document.getElementById('aiAnswer');
      const textContent = answerDiv.innerText || answerDiv.textContent;
      navigator.clipboard.writeText(textContent);
      alert('Copied to clipboard');
    };

    // Help Modal functionality
    const helpModal = document.getElementById('helpModal');
    let pendingSectionUrl = '';
    let showHelpModal = localStorage.getItem('showSectionHelp') !== 'false';

    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('section-link')) {
        e.preventDefault();
        const url = e.target.getAttribute('data-url');
        const law = e.target.getAttribute('data-law');
        const section = e.target.getAttribute('data-section');
        
        pendingSectionUrl = url;
        
        if (showHelpModal) {
          document.getElementById('helpSectionText').textContent = `${law} Section ${section}`;
          document.getElementById('helpSectionNum').textContent = section;
          helpModal.classList.remove('hidden');
          lucide.createIcons();
        } else {
          window.open(url, '_blank');
        }
      }
    });

    document.getElementById('closeHelpModal').onclick = () => {
      helpModal.classList.add('hidden');
    };

    document.getElementById('proceedToSection').onclick = () => {
      window.open(pendingSectionUrl, '_blank');
      helpModal.classList.add('hidden');
    };

    document.getElementById('dontShowAgain').onclick = () => {
      showHelpModal = false;
      localStorage.setItem('showSectionHelp', 'false');
      window.open(pendingSectionUrl, '_blank');
      helpModal.classList.add('hidden');
    };
  </script>
</body>
</html>
