<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Chat Test</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f4f8; }
    .btn { padding: 5px 10px; margin-right: 5px; cursor: pointer; border-radius: 4px; border: none; }
    .btn.active { background: #007bff; color: white; }
    #answer { margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ccc; min-height: 50px; }
  </style>
</head>
<body>

<h2>AI Chat Test</h2>

<label>Your Name:</label>
<input id="name" placeholder="Anonymous" /><br><br>

<label>Question:</label>
<textarea id="question" rows="3" style="width:100%;"></textarea><br><br>

<label>Language:</label>
<button class="btn active" data-lang="English">English</button>
<button class="btn" data-lang="Hindi">Hindi</button>
<button class="btn" data-lang="Punjabi">Punjabi</button><br><br>

<button id="askBtn">Ask AI</button>

<div id="answer">Answer will appear here...</div>

<script>
  lucide.createIcons();

  const WEBHOOK_URL = 'https://vinodnic.app.n8n.cloud/webhook/chatbotwithopenAi';
  let selectedLang = 'English';

  document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('click', function() {
      selectedLang = this.dataset.lang;
      document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
    });
  });

  async function askAI(retryCount = 0) {
    const name = document.getElementById('name').value.trim() || 'Anonymous';
    const question = document.getElementById('question').value.trim();
    if(!question) { alert('Please type a question'); return; }
    const answerDiv = document.getElementById('answer');
    answerDiv.textContent = 'Getting response...';

    try {
      const res = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, question, language: selectedLang })
      });

      let data;
      try { data = await res.json(); } catch(e) { data = null; }

      // If empty or invalid response, retry once
      if(!data || !data.answer) {
        if(retryCount < 1) {
          setTimeout(() => askAI(retryCount + 1), 1000); // retry after 1s
          return;
        } else {
          answerDiv.textContent = 'Partial or no response received. Try again.';
          return;
        }
      }

      answerDiv.textContent = data.answer;

    } catch(err) {
      answerDiv.textContent = 'Error fetching response: ' + err.message;
    }
  }

  document.getElementById('askBtn').addEventListener('click', () => askAI());
</script>

</body>
</html>
